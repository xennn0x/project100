//+------------------------------------------------------------------+
//|                      Project100_Final_v1.17.mq5                  |
//|    Tampilan Input Bersih (Clean UI) + Waktu WIB + Pesan Polos    |
//+------------------------------------------------------------------+
#property strict
#property version   "1.17"

#include <Trade\PositionInfo.mqh>
#include <Trade\Trade.mqh>

// --- INPUT PARAMETERS (TAMPILAN SEDERHANA) ---
input double TargetProfit     = 100.0; // Target Profit ($)
input double LotAwal          = 0.01;  // Lot Awal
input int    JedaAntiSpam     = 3;     // Jeda Anti Spam (Detik)
input double JarakGrid        = 2.0;   // Jarak Grid ($)
input int    JamMulai_WIB     = 7;     // Ea On (Jam WIB)
input int    JamStop_WIB      = 23;    // Ea Off (Jam WIB)
input int    InfoTelegram     = 5;     // Info Telegram (Menit)
input string TelegramToken    = "8571105656:AAHyTtdXkmQjkDZGZsJcO8_mc9clrafyc_8"; // Telegram Token
input string TelegramChatID   = "6575521535"; // Telegram ID

// --- SETTINGAN INTERNAL (TIDAK MUNCUL DI INPUT) ---
// (Jika mau ubah, ubah di sini lalu Compile)
const int    LevelsPerStep   = 4;      // Step Martingale
const int    MagicNumber     = 123456; // ID Robot
const bool   InpResetOnStart = false;  // Reset
const bool   UseTimeFilter   = true;   // Fitur Waktu Selalu Aktif

// --- GLOBAL VARIABLES ---
double buyLotRefPrice = 0;  
double sellLotRefPrice = 0;
datetime lastExecutionTime = 0; 
datetime lastReportTime = 0; 
bool needReset = false;

CPositionInfo positionInfo;
CTrade trade;

//+------------------------------------------------------------------+
//| Init                                                             |
//+------------------------------------------------------------------+
int OnInit() {
    trade.SetExpertMagicNumber(MagicNumber);
    trade.SetTypeFillingBySymbol(_Symbol);
    
    double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    buyLotRefPrice = price;
    sellLotRefPrice = price;
    
    needReset = InpResetOnStart;
    lastReportTime = TimeCurrent(); 

    string statusWaktu = UseTimeFilter ? "Aktif ("+(string)JamMulai_WIB+"-"+(string)JamStop_WIB+" WIB)" : "Non-Aktif";
    
    Print("Mencoba kirim pesan tes Telegram...");
    SendTelegram("##### EA CONNECTED (v1.17) #####\nTime Filter: " + statusWaktu);
    
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| OnTick                                                           |
//+------------------------------------------------------------------+
void OnTick()
{
   if(StringFind(_Symbol, "XAUUSD") < 0) return;
   
   // 1. TIMER: Laporan Info Rutin
   if(TimeCurrent() - lastReportTime >= (InfoTelegram * 60)) {
      SendPeriodicReport();
      lastReportTime = TimeCurrent();
   }

   // 2. Logic Reset / Init
   if(buyLotRefPrice == 0 || needReset) {
      InitBase();
      if(needReset) needReset = false;
      return;
   }

   // 3. Tentukan Level Grid
   double currentBid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   int currentLevel = (int)(MathRound(currentBid / JarakGrid) * JarakGrid); 

   if(currentLevel <= 0) return;

   // 4. Cek Take Profit
   CheckTakeProfit(currentLevel);

   // 5. Manage Grid
   if(TimeCurrent() >= lastExecutionTime + JedaAntiSpam) {
      ManageGrid(currentLevel);
   }
}

//+------------------------------------------------------------------+
//| Fungsi Hitung Waktu WIB (GMT+7)                                  |
//+------------------------------------------------------------------+
datetime GetWIBTime() {
   return TimeGMT() + (7 * 3600);
}

//+------------------------------------------------------------------+
//| Fungsi Cek Waktu Trading                                         |
//+------------------------------------------------------------------+
bool IsTradingTime() {
   if(!UseTimeFilter) return true; 
   
   MqlDateTime dt;
   TimeToStruct(GetWIBTime(), dt);
   int h = dt.hour;
   
   if(JamMulai_WIB < JamStop_WIB) {
      if(h >= JamMulai_WIB && h < JamStop_WIB) return true;
   }
   else {
      if(h >= JamMulai_WIB || h < JamStop_WIB) return true;
   }
   return false;
}

//+------------------------------------------------------------------+
//| Manage Grid                                                      |
//+------------------------------------------------------------------+
void ManageGrid(int level) {
   bool buyExist = IsOrderExistsById(level, POSITION_TYPE_BUY);
   bool sellExist = IsOrderExistsById(level, POSITION_TYPE_SELL);
   bool isTime = IsTradingTime(); 

   // --- LOGIKA BUY ---
   if(!buyExist) {
      double totalBuy = GetTotalLots(POSITION_TYPE_BUY);
      if(isTime || totalBuy > 0) { // Boleh entry jika Jam On ATAU Refill posisi lama
         if(OpenOrder(ORDER_TYPE_BUY, level, CalculateLot(level, true)))
            lastExecutionTime = TimeCurrent();
      }
   }
   
   // --- LOGIKA SELL ---
   if(!sellExist) {
      if(TimeCurrent() >= lastExecutionTime + JedaAntiSpam) {
         double totalSell = GetTotalLots(POSITION_TYPE_SELL);
         if(isTime || totalSell > 0) {
            if(OpenOrder(ORDER_TYPE_SELL, level, CalculateLot(level, false)))
               lastExecutionTime = TimeCurrent();
         }
      }
   }
}

//+------------------------------------------------------------------+
//| Laporan Info Rutin                                               |
//+------------------------------------------------------------------+
void SendPeriodicReport() {
   double totalBuyLot = GetTotalLots(POSITION_TYPE_BUY);
   double totalSellLot = GetTotalLots(POSITION_TYPE_SELL);
   double totalLot = totalBuyLot + totalSellLot;
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   string statusJam = IsTradingTime() ? "ON (Trading)" : "OFF (Waiting)";
   string wibString = TimeToString(GetWIBTime(), TIME_DATE|TIME_SECONDS) + " WIB";
   
   string msg = "##### INFO UPDATE (" + (string)InfoTelegram + "m) #####\n"
              + "Mode: " + statusJam + "\n"
              + "Total Lot: " + DoubleToString(totalLot, 2) + "\n"
              + "Lot Buy: " + DoubleToString(totalBuyLot, 2) + "\n"
              + "Lot Sell: " + DoubleToString(totalSellLot, 2) + "\n"
              + "Harga: " + DoubleToString(price, 2) + "\n"
              + "Equity: $" + DoubleToString(AccountInfoDouble(ACCOUNT_EQUITY), 2) + "\n"
              + "Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
              + "Waktu: " + wibString;
              
   SendTelegram(msg);
}

//+------------------------------------------------------------------+
//| Init Base                                                        |
//+------------------------------------------------------------------+
void InitBase() {
   CloseAllOrders();
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   buyLotRefPrice = price;
   sellLotRefPrice = price;
   string wibString = TimeToString(GetWIBTime(), TIME_DATE|TIME_SECONDS) + " WIB";
   
   string msg = "##### EA ACTIVATED #####\n"
              + "Grid Step: $" + DoubleToString(JarakGrid, 0) + "\n"
              + "Start Price: " + DoubleToString(price, 2) + "\n"
              + "Waktu Start: " + wibString;
              
   SendTelegram(msg);
   lastExecutionTime = TimeCurrent();
   lastReportTime = TimeCurrent(); 
}

//+------------------------------------------------------------------+
//| Cek TP                                                           |
//+------------------------------------------------------------------+
void CheckTakeProfit(int currentLevel) {
   string wibString = TimeToString(GetWIBTime(), TIME_DATE|TIME_SECONDS) + " WIB";
   
   // --- TIM BUY ---
   double bProfit = CalculateProfit(POSITION_TYPE_BUY);
   if(bProfit >= TargetProfit) {
      ClosePositions(POSITION_TYPE_BUY);
      buyLotRefPrice = (double)currentLevel; 
      
      string msg = "##### TP BUY HIT (+$" + DoubleToString(bProfit, 2) + ") #####\n"
                 + "New Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "Waktu: " + wibString;
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }

   // --- TIM SELL ---
   double sProfit = CalculateProfit(POSITION_TYPE_SELL);
   if(sProfit >= TargetProfit) {
      ClosePositions(POSITION_TYPE_SELL);
      sellLotRefPrice = (double)currentLevel;
      
      string msg = "##### TP SELL HIT (+$" + DoubleToString(sProfit, 2) + ") #####\n"
                 + "New Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "Waktu: " + wibString;
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }
}

//+------------------------------------------------------------------+
//| Helper Functions                                                 |
//+------------------------------------------------------------------+
bool OpenOrder(ENUM_ORDER_TYPE type, int level, double lot) {
   double price = (type == ORDER_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_ASK) : SymbolInfoDouble(_Symbol, SYMBOL_BID);
   string comment = "L:" + (string)level; 
   if(trade.PositionOpen(_Symbol, type, lot, price, 0, 0, comment)) {
      if(trade.ResultRetcode() == TRADE_RETCODE_DONE) return true;
   }
   return false;
}

double GetTotalLots(ENUM_POSITION_TYPE type) {
   double total = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
         total += positionInfo.Volume();
      }
   }
   return total;
}

bool IsOrderExistsById(int level, ENUM_POSITION_TYPE type) {
   string searchComment = "L:" + (string)level; 
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i)) {
         if(positionInfo.Symbol() == _Symbol && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
            if(StringFind(positionInfo.Comment(), searchComment) >= 0) return true;
            if(MathAbs(positionInfo.PriceOpen() - (double)level) < (JarakGrid/2.0)) return true;
         }
      }
   }
   return false;
}

double CalculateLot(int level, bool isBuy) {
   double refPrice = isBuy ? buyLotRefPrice : sellLotRefPrice;
   int distance = (int)MathAbs((double)level - refPrice);
   int stepsAway = (int)(distance / JarakGrid);
   int martingaleLevel = stepsAway / LevelsPerStep;
   double lot = LotAwal * MathPow(2, martingaleLevel);
   double step = SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_STEP);
   lot = MathFloor(lot / step) * step;
   return MathMax(SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_MIN), lot);
}

double CalculateProfit(ENUM_POSITION_TYPE type) {
   double p = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         p += positionInfo.Profit() + positionInfo.Commission() + positionInfo.Swap();
   }
   return p;
}

void ClosePositions(ENUM_POSITION_TYPE type) {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         trade.PositionClose(positionInfo.Ticket());
   }
}

void CloseAllOrders() {
   ClosePositions(POSITION_TYPE_BUY);
   ClosePositions(POSITION_TYPE_SELL);
}

void SendTelegram(string message) {
   string url = "https://api.telegram.org/bot"+TelegramToken+"/sendMessage";
   string params = "chat_id="+TelegramChatID+"&text="+message; 
   char post_data[]; StringToCharArray(params, post_data);
   string headers = "Content-Type: application/x-www-form-urlencoded";
   uchar response[]; string result;
   ResetLastError();
   int res = WebRequest("POST", url, headers, 3000, post_data, response, result);
   if(res != 200 && res != -1) Print("Telegram Error: ", res);
}
