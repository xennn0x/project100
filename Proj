//+------------------------------------------------------------------+
//|                                              Project100_Fix2.mq5 |
//|                                  Optimized Grid EA - No Spam     |
//+------------------------------------------------------------------+
#property strict
#property version   "1.02"

#include <Trade\PositionInfo.mqh>
#include <Trade\Trade.mqh>

input double ProfitTarget = 100.0;
input double InitialLot   = 0.01;
input int    LevelsPerStep = 4;
input int    MagicNumber  = 123456;
input bool   InpResetOnStart = false; // Nama input diganti agar aman
input int    DelaySeconds = 5; 

// --- Telegram Notification ---
input string TelegramToken = "8571105656:AAH8DMkfIVljFYQgExha0SrCw2rVrvDeBYA";
input string TelegramChatID = "6575521535";

// Variabel Global
double basePrice = 0;
int buyBaseLevel = 0;
int sellBaseLevel = 0;
bool needReset = false; // Variabel internal pengganti input

// Anti-spam global timer
datetime lastExecutionTime = 0;

CPositionInfo positionInfo;
CTrade trade;

//+------------------------------------------------------------------+
int OnInit() {
    trade.SetExpertMagicNumber(MagicNumber);
    trade.SetTypeFillingBySymbol(_Symbol);
    
    // Salin status reset dari input ke variabel internal
    needReset = InpResetOnStart;
    
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
void OnTick()
{
   if(StringFind(_Symbol, "XAUUSD") < 0) {
      Comment("Hanya untuk XAUUSD");
      return;
   }

   // Jeda eksekusi global untuk mencegah spam per tick
   if(TimeCurrent() < lastExecutionTime + DelaySeconds) return;

   // Logika Inisialisasi atau Reset
   if(basePrice == 0 || needReset) {
      InitBase();
      if(needReset) needReset = false; // Matikan flag reset setelah dieksekusi
      return;
   }

   double currentBid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   int currentLevel = (int)MathFloor(currentBid - basePrice);

   // Batasan level aman
   if(currentLevel < -500 || currentLevel > 500) return;

   // --- Logika Take Profit ---
   CheckTakeProfit(currentLevel);

   // --- Eksekusi Grid ---
   ManageGrid(currentLevel);
}

//+------------------------------------------------------------------+
void InitBase() {
   basePrice = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   buyBaseLevel = 0;
   sellBaseLevel = 0;
   
   CloseAllOrders();
   
   // Buka order awal
   OpenOrder(ORDER_TYPE_BUY, 0, CalculateLot(0, true));
   OpenOrder(ORDER_TYPE_SELL, 0, CalculateLot(0, false));
   
   SendTelegram("✓✓ [EA STARTED/RESET] "+_Symbol+"\nPrice: "+DoubleToString(basePrice,2));
   lastExecutionTime = TimeCurrent();
}

//+------------------------------------------------------------------+
void ManageGrid(int currentLevel) {
   bool buyExist = OrderExistsAtLevel(currentLevel, POSITION_TYPE_BUY);
   bool sellExist = OrderExistsAtLevel(currentLevel, POSITION_TYPE_SELL);

   if(!buyExist) {
      if(OpenOrder(ORDER_TYPE_BUY, currentLevel, CalculateLot(currentLevel, true)))
         lastExecutionTime = TimeCurrent();
   }
   
   if(!sellExist) {
      if(OpenOrder(ORDER_TYPE_SELL, currentLevel, CalculateLot(currentLevel, false)))
         lastExecutionTime = TimeCurrent();
   }
}

//+------------------------------------------------------------------+
void CheckTakeProfit(int currentLevel) {
   double bProfit = CalculateProfit(POSITION_TYPE_BUY);
   if(bProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_BUY);
      buyBaseLevel = currentLevel;
      SendTelegram("✓ [TP BUY] Profit: $"+DoubleToString(bProfit,2));
      lastExecutionTime = TimeCurrent();
   }

   double sProfit = CalculateProfit(POSITION_TYPE_SELL);
   if(sProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_SELL);
      sellBaseLevel = currentLevel;
      SendTelegram("✓ [TP SELL] Profit: $"+DoubleToString(sProfit,2));
      lastExecutionTime = TimeCurrent();
   }
}

//+------------------------------------------------------------------+
bool OpenOrder(ENUM_ORDER_TYPE type, int level, double lot) {
   double price = (type == ORDER_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_ASK) : SymbolInfoDouble(_Symbol, SYMBOL_BID);
   
   if(trade.PositionOpen(_Symbol, type, lot, price, 0, 0, "Level: "+(string)level)) {
      if(trade.ResultRetcode() == TRADE_RETCODE_DONE) return true;
   }
   return false;
}

//+------------------------------------------------------------------+
bool OrderExistsAtLevel(int level, ENUM_POSITION_TYPE type) {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i)) {
         if(positionInfo.Symbol() == _Symbol && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
            int posLevel = (int)MathFloor(positionInfo.PriceOpen() - basePrice);
            if(posLevel == level) return true;
         }
      }
   }
   return false;
}

//+------------------------------------------------------------------+
double CalculateLot(int level, bool isBuy) {
   int base = isBuy ? buyBaseLevel : sellBaseLevel;
   int distance = MathAbs(level - base);
   int stepIndex = distance / LevelsPerStep;
   
   double lot = InitialLot * MathPow(2, stepIndex);
   double step = SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_STEP);
   lot = MathFloor(lot / step) * step;
   
   double minLot = SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_MIN);
   return MathMax(minLot, lot);
}

//+------------------------------------------------------------------+
double CalculateProfit(ENUM_POSITION_TYPE type) {
   double p = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         p += positionInfo.Profit() + positionInfo.Commission() + positionInfo.Swap();
   }
   return p;
}

//+------------------------------------------------------------------+
void ClosePositions(ENUM_POSITION_TYPE type) {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         trade.PositionClose(positionInfo.Ticket());
   }
}

void CloseAllOrders() {
   ClosePositions(POSITION_TYPE_BUY);
   ClosePositions(POSITION_TYPE_SELL);
}

//+------------------------------------------------------------------+
void SendTelegram(string message) {
   string url = "https://api.telegram.org/bot"+TelegramToken+"/sendMessage";
   string params = "chat_id="+TelegramChatID+"&text="+message;
   char post_data[]; StringToCharArray(params, post_data);
   string headers = "Content-Type: application/x-www-form-urlencoded";
   uchar response[]; string result;
   WebRequest("POST", url, headers, 3000, post_data, response, result);
}
//+------------------------------------------------------------------+
