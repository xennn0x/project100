//+------------------------------------------------------------------+
//|                      Project100_Final_v1.10.mq5                  |
//|    Grid Step $2 + Periodic Info + Telegram Debugger              |
//+------------------------------------------------------------------+
#property strict
#property version   "1.10"

#include <Trade\PositionInfo.mqh>
#include <Trade\Trade.mqh>

// --- INPUT PARAMETERS ---
input double ProfitTarget = 100.0;   // Target Profit ($)
input double InitialLot   = 0.01;    // Lot awal
input double GridStep     = 2.0;     // JARAK GRID ($2)
input int    LevelsPerStep = 4;      // Step Martingale
input int    MagicNumber  = 123456;  
input bool   InpResetOnStart = false;
input int    DelaySeconds = 3;       // Jeda Anti-Spam Eksekusi

// --- LAPORAN INFO (TIMER) ---
input int    ReportIntervalMinutes = 5; // Kirim Info Akun tiap X menit

// --- TELEGRAM ---
input string TelegramToken = "8571105656:AAH8DMkfIVljFYQgExha0SrCw2rVrvDeBYA";
input string TelegramChatID = "6575521535";

// --- GLOBAL VARIABLES ---
double buyLotRefPrice = 0;  
double sellLotRefPrice = 0;
datetime lastExecutionTime = 0; 
datetime lastReportTime = 0; 
bool needReset = false;

CPositionInfo positionInfo;
CTrade trade;

//+------------------------------------------------------------------+
//| Init                                                             |
//+------------------------------------------------------------------+
int OnInit() {
    trade.SetExpertMagicNumber(MagicNumber);
    trade.SetTypeFillingBySymbol(_Symbol);
    
    double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    buyLotRefPrice = price;
    sellLotRefPrice = price;
    
    needReset = InpResetOnStart;
    lastReportTime = TimeCurrent(); 

    // KIRIM PESAN TEST SAAT PASANG
    // Agar ketahuan kalau error
    Print("Mencoba kirim pesan tes Telegram...");
    SendTelegram("üîå *EA CONNECTED*\nüìÖ " + TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS));
    
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| OnTick                                                           |
//+------------------------------------------------------------------+
void OnTick()
{
   if(StringFind(_Symbol, "XAUUSD") < 0) return;
   
   // 1. TIMER: Laporan Info Rutin (Info Lot, Equity, dll)
   if(TimeCurrent() - lastReportTime >= (ReportIntervalMinutes * 60)) {
      SendPeriodicReport();
      lastReportTime = TimeCurrent();
   }

   // 2. Logic Reset / Init (INSTANT)
   if(buyLotRefPrice == 0 || needReset) {
      InitBase();
      if(needReset) needReset = false;
      return;
   }

   // 3. Tentukan Level Grid ($2 Step)
   double currentBid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   int currentLevel = (int)(MathRound(currentBid / GridStep) * GridStep); 

   if(currentLevel <= 0) return;

   // 4. Cek Take Profit (INSTANT)
   CheckTakeProfit(currentLevel);

   // 5. Manage Grid (Delay Anti-Spam)
   if(TimeCurrent() >= lastExecutionTime + DelaySeconds) {
      ManageGrid(currentLevel);
   }
}

//+------------------------------------------------------------------+
//| Laporan Info Rutin (Pesan Terpisah)                              |
//+------------------------------------------------------------------+
void SendPeriodicReport() {
   double totalBuyLot = GetTotalLots(POSITION_TYPE_BUY);
   double totalSellLot = GetTotalLots(POSITION_TYPE_SELL);
   double totalLot = totalBuyLot + totalSellLot;
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   
   string msg = "üìä *INFO UPDATE* (" + (string)ReportIntervalMinutes + "m)\n"
              + "------------------------\n"
              + "‚öñÔ∏è Total Lot: " + DoubleToString(totalLot, 2) + "\n"
              + "üü¢ Lot Buy: " + DoubleToString(totalBuyLot, 2) + "\n"
              + "üî¥ Lot Sell: " + DoubleToString(totalSellLot, 2) + "\n"
              + "üí≤ Harga: " + DoubleToString(price, 2) + "\n"
              + "üíµ Equity: $" + DoubleToString(AccountInfoDouble(ACCOUNT_EQUITY), 2) + "\n"
              + "üí∞ Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
              + "üìÖ " + TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS);
              
   SendTelegram(msg);
}

//+------------------------------------------------------------------+
//| Init Base (Pesan START)                                          |
//+------------------------------------------------------------------+
void InitBase() {
   CloseAllOrders();
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   buyLotRefPrice = price;
   sellLotRefPrice = price;
   
   string msg = "ü§ñ *EA ACTIVATED*\n"
              + "------------------------\n"
              + "üìè Grid Step: $" + DoubleToString(GridStep, 0) + "\n"
              + "üèÅ Start Price: " + DoubleToString(price, 2) + "\n"
              + "üíµ Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
              + "üìÖ " + TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS);
              
   SendTelegram(msg);
   lastExecutionTime = TimeCurrent();
   lastReportTime = TimeCurrent(); 
}

//+------------------------------------------------------------------+
//| Cek TP (Pesan TP)                                                |
//+------------------------------------------------------------------+
void CheckTakeProfit(int currentLevel) {
   // --- TIM BUY ---
   double bProfit = CalculateProfit(POSITION_TYPE_BUY);
   if(bProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_BUY);
      buyLotRefPrice = (double)currentLevel; 
      
      string msg = "üí∞ *TP BUY HIT* (+$" + DoubleToString(bProfit, 2) + ")\n"
                 + "------------------------\n"
                 + "üîÑ Reset Cycle: " + (string)currentLevel + "\n"
                 + "üíµ New Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "üìÖ " + TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS);
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }

   // --- TIM SELL ---
   double sProfit = CalculateProfit(POSITION_TYPE_SELL);
   if(sProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_SELL);
      sellLotRefPrice = (double)currentLevel;
      
      string msg = "üíé *TP SELL HIT* (+$" + DoubleToString(sProfit, 2) + ")\n"
                 + "------------------------\n"
                 + "üîÑ Reset Cycle: " + (string)currentLevel + "\n"
                 + "üíµ New Balance: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "üìÖ " + TimeToString(TimeCurrent(), TIME_DATE|TIME_SECONDS);
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }
}

//+------------------------------------------------------------------+
//| Manage Grid                                                      |
//+------------------------------------------------------------------+
void ManageGrid(int level) {
   bool buyExist = IsOrderExistsById(level, POSITION_TYPE_BUY);
   bool sellExist = IsOrderExistsById(level, POSITION_TYPE_SELL);

   if(!buyExist) {
      if(OpenOrder(ORDER_TYPE_BUY, level, CalculateLot(level, true)))
         lastExecutionTime = TimeCurrent();
   }
   
   if(!sellExist) {
      if(TimeCurrent() >= lastExecutionTime + DelaySeconds) {
         if(OpenOrder(ORDER_TYPE_SELL, level, CalculateLot(level, false)))
            lastExecutionTime = TimeCurrent();
      }
   }
}

//+------------------------------------------------------------------+
//| Helper Functions                                                 |
//+------------------------------------------------------------------+
bool OpenOrder(ENUM_ORDER_TYPE type, int level, double lot) {
   double price = (type == ORDER_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_ASK) : SymbolInfoDouble(_Symbol, SYMBOL_BID);
   string comment = "L:" + (string)level; 
   if(trade.PositionOpen(_Symbol, type, lot, price, 0, 0, comment)) {
      if(trade.ResultRetcode() == TRADE_RETCODE_DONE) return true;
   }
   return false;
}

double GetTotalLots(ENUM_POSITION_TYPE type) {
   double total = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
         total += positionInfo.Volume();
      }
   }
   return total;
}

bool IsOrderExistsById(int level, ENUM_POSITION_TYPE type) {
   string searchComment = "L:" + (string)level; 
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i)) {
         if(positionInfo.Symbol() == _Symbol && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
            if(StringFind(positionInfo.Comment(), searchComment) >= 0) return true;
            if(MathAbs(positionInfo.PriceOpen() - (double)level) < (GridStep/2.0)) return true;
         }
      }
   }
   return false;
}

double CalculateLot(int level, bool isBuy) {
   double refPrice = isBuy ? buyLotRefPrice : sellLotRefPrice;
   int distance = (int)MathAbs((double)level - refPrice);
   int stepsAway = (int)(distance / GridStep);
   int martingaleLevel = stepsAway / LevelsPerStep;
   double lot = InitialLot * MathPow(2, martingaleLevel);
   double step = SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_STEP);
   lot = MathFloor(lot / step) * step;
   return MathMax(SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_MIN), lot);
}

double CalculateProfit(ENUM_POSITION_TYPE type) {
   double p = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         p += positionInfo.Profit() + positionInfo.Commission() + positionInfo.Swap();
   }
   return p;
}

void ClosePositions(ENUM_POSITION_TYPE type) {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         trade.PositionClose(positionInfo.Ticket());
   }
}

void CloseAllOrders() {
   ClosePositions(POSITION_TYPE_BUY);
   ClosePositions(POSITION_TYPE_SELL);
}

//+------------------------------------------------------------------+
//| KIRIM TELEGRAM (DEBUG MODE)                                      |
//+------------------------------------------------------------------+
void SendTelegram(string message) {
   string url = "https://api.telegram.org/bot"+TelegramToken+"/sendMessage";
   string params = "chat_id="+TelegramChatID+"&text="+message+"&parse_mode=Markdown"; 
   
   char post_data[]; StringToCharArray(params, post_data);
   string headers = "Content-Type: application/x-www-form-urlencoded";
   uchar response[]; string result;
   
   ResetLastError();
   int timeout = 5000; 
   int res = WebRequest("POST", url, headers, timeout, post_data, response, result);
   
   // --- DIAGNOSA ERROR JIKA GAGAL ---
   if(res == -1) {
      int err = GetLastError();
      Print("‚ùå TELEGRAM GAGAL! Error Code: ", err);
      
      if(err == 4060) Print("üëâ SOLUSI: Cek Tools > Options > Expert Advisors. Pastikan URL 'https://api.telegram.org' ada di daftar.");
      if(err == 4014) Print("üëâ SOLUSI: WebRequest DILARANG di Strategy Tester/Backtest. Pasang di Chart Live/Demo.");
      if(err == 5200) Print("üëâ SOLUSI: Koneksi internet putus atau URL Token salah.");
   } 
   else if(res != 200) {
      Print("‚ö†Ô∏è TELEGRAM DITOLAK SERVER. HTTP Code: ", res);
      Print("Respon Server: ", CharArrayToString(response));
   }
   else {
      Print("‚úÖ Telegram Berhasil Terkirim!");
   }
}
