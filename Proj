//+------------------------------------------------------------------+
//|                        Project100_Final_AutoReport_v1.07.mq5     |
//|    Grid Abadi + Anti Spam + Laporan Rutin (Periodic Report)      |
//+------------------------------------------------------------------+
#property strict
#property version   "1.07"

#include <Trade\PositionInfo.mqh>
#include <Trade\Trade.mqh>

// --- INPUT PARAMETERS ---
input double ProfitTarget = 100.0;   // Target Profit ($)
input double InitialLot   = 0.01;    // Lot awal
input int    LevelsPerStep = 4;      // Step Martingale
input int    MagicNumber  = 123456;  
input bool   InpResetOnStart = false;// Reset posisi saat start?
input int    DelaySeconds = 3;       // Jeda Anti-Spam (Detik)

// --- SETTINGAN LAPORAN RUTIN ---
input int    ReportIntervalMinutes = 5; // Kirim laporan status tiap X menit

// --- TELEGRAM ---
input string TelegramToken = "8571105656:AAH8DMkfIVljFYQgExha0SrCw2rVrvDeBYA";
input string TelegramChatID = "6575521535";

// --- GLOBAL VARIABLES ---
double buyLotRefPrice = 0;  
double sellLotRefPrice = 0;
datetime lastExecutionTime = 0; 
datetime lastReportTime = 0; // Timer untuk laporan rutin
bool needReset = false;

CPositionInfo positionInfo;
CTrade trade;

//+------------------------------------------------------------------+
//| Init                                                             |
//+------------------------------------------------------------------+
int OnInit() {
    trade.SetExpertMagicNumber(MagicNumber);
    trade.SetTypeFillingBySymbol(_Symbol);
    
    double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    buyLotRefPrice = price;
    sellLotRefPrice = price;
    
    needReset = InpResetOnStart;
    lastReportTime = TimeCurrent(); // Mulai hitung waktu dari sekarang
    
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| OnTick                                                           |
//+------------------------------------------------------------------+
void OnTick()
{
   if(StringFind(_Symbol, "XAUUSD") < 0) return;
   
   // 1. Cek Timer Laporan Rutin (Auto Report)
   if(TimeCurrent() - lastReportTime >= (ReportIntervalMinutes * 60)) {
      SendPeriodicReport();
      lastReportTime = TimeCurrent();
   }

   // 2. Anti-Spam Eksekusi Order
   if(TimeCurrent() < lastExecutionTime + DelaySeconds) return;

   // 3. Logic Reset / Init
   if(buyLotRefPrice == 0 || needReset) {
      InitBase();
      if(needReset) needReset = false;
      return;
   }

   // 4. Tentukan Level (Absolut)
   double currentBid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   int currentAbsLevel = (int)MathRound(currentBid); 

   if(currentAbsLevel <= 0) return;

   // 5. Cek Take Profit
   CheckTakeProfit(currentAbsLevel);

   // 6. Manage Grid (Auto Refill)
   ManageGrid(currentAbsLevel);
}

//+------------------------------------------------------------------+
//| Fungsi Kirim Laporan Berkala (Sesuai Request)                    |
//+------------------------------------------------------------------+
void SendPeriodicReport() {
   double totalBuyLot = GetTotalLots(POSITION_TYPE_BUY);
   double totalSellLot = GetTotalLots(POSITION_TYPE_SELL);
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   
   string msg = "ðŸ“Š *STATUS UPDATE* (" + (string)ReportIntervalMinutes + "m)\n"
              + "------------------------\n"
              + "âš–ï¸ Lot Buy: " + DoubleToString(totalBuyLot, 2) + "\n"
              + "âš–ï¸ Lot Sell: " + DoubleToString(totalSellLot, 2) + "\n"
              + "ðŸ’µ Equity: $" + DoubleToString(AccountInfoDouble(ACCOUNT_EQUITY), 2) + "\n"
              + "ðŸ’² Harga: " + DoubleToString(price, 2) + "\n"
              + "â³ Waktu: " + TimeToString(TimeCurrent(), TIME_MINUTES);
              
   SendTelegram(msg);
}

//+------------------------------------------------------------------+
//| Init Base (Pesan START)                                          |
//+------------------------------------------------------------------+
void InitBase() {
   CloseAllOrders();
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   buyLotRefPrice = price;
   sellLotRefPrice = price;
   
   string msg = "ðŸ¤– *EA STARTED*\n"
              + "------------------------\n"
              + "ðŸ’µ Saldo: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
              + "â³ Waktu: " + TimeToString(TimeCurrent(), TIME_DATE|TIME_MINUTES);
              
   SendTelegram(msg);
   lastExecutionTime = TimeCurrent();
   lastReportTime = TimeCurrent(); // Reset timer laporan
}

//+------------------------------------------------------------------+
//| Cek TP                                                           |
//+------------------------------------------------------------------+
void CheckTakeProfit(int currentLevel) {
   // --- TIM BUY ---
   double bProfit = CalculateProfit(POSITION_TYPE_BUY);
   if(bProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_BUY);
      buyLotRefPrice = (double)currentLevel; 
      
      string msg = "ðŸ’° *TP BUY HIT* ðŸ’°\n"
                 + "------------------------\n"
                 + "ðŸ¤‘ Profit: $" + DoubleToString(bProfit, 2) + "\n"
                 + "ðŸ’¼ Saldo: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "â³ Waktu: " + TimeToString(TimeCurrent(), TIME_MINUTES);
                 
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }

   // --- TIM SELL ---
   double sProfit = CalculateProfit(POSITION_TYPE_SELL);
   if(sProfit >= ProfitTarget) {
      ClosePositions(POSITION_TYPE_SELL);
      sellLotRefPrice = (double)currentLevel;
      
      string msg = "ðŸ’Ž *TP SELL HIT* ðŸ’Ž\n"
                 + "------------------------\n"
                 + "ðŸ¤‘ Profit: $" + DoubleToString(sProfit, 2) + "\n"
                 + "ðŸ’¼ Saldo: $" + DoubleToString(AccountInfoDouble(ACCOUNT_BALANCE), 2) + "\n"
                 + "â³ Waktu: " + TimeToString(TimeCurrent(), TIME_MINUTES);
                 
      SendTelegram(msg);
      lastExecutionTime = TimeCurrent();
   }
}

//+------------------------------------------------------------------+
//| Manage Grid                                                      |
//+------------------------------------------------------------------+
void ManageGrid(int level) {
   bool buyExist = IsOrderExistsById(level, POSITION_TYPE_BUY);
   bool sellExist = IsOrderExistsById(level, POSITION_TYPE_SELL);

   if(!buyExist) {
      if(OpenOrder(ORDER_TYPE_BUY, level, CalculateLot(level, true)))
         lastExecutionTime = TimeCurrent();
   }
   
   if(!sellExist) {
      if(TimeCurrent() >= lastExecutionTime + DelaySeconds) {
         if(OpenOrder(ORDER_TYPE_SELL, level, CalculateLot(level, false)))
            lastExecutionTime = TimeCurrent();
      }
   }
}

//+------------------------------------------------------------------+
//| Helper Functions                                                 |
//+------------------------------------------------------------------+
bool OpenOrder(ENUM_ORDER_TYPE type, int level, double lot) {
   double price = (type == ORDER_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_ASK) : SymbolInfoDouble(_Symbol, SYMBOL_BID);
   string comment = "L:" + (string)level; 
   if(trade.PositionOpen(_Symbol, type, lot, price, 0, 0, comment)) {
      if(trade.ResultRetcode() == TRADE_RETCODE_DONE) return true;
   }
   return false;
}

double GetTotalLots(ENUM_POSITION_TYPE type) {
   double total = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
         total += positionInfo.Volume();
      }
   }
   return total;
}

bool IsOrderExistsById(int level, ENUM_POSITION_TYPE type) {
   string searchComment = "L:" + (string)level; 
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i)) {
         if(positionInfo.Symbol() == _Symbol && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type) {
            if(StringFind(positionInfo.Comment(), searchComment) >= 0) return true;
            if(MathAbs(positionInfo.PriceOpen() - (double)level) < 0.5) return true;
         }
      }
   }
   return false;
}

double CalculateLot(int level, bool isBuy) {
   double refPrice = isBuy ? buyLotRefPrice : sellLotRefPrice;
   int distance = (int)MathAbs((double)level - refPrice);
   int stepIndex = distance / LevelsPerStep;
   double lot = InitialLot * MathPow(2, stepIndex);
   double step = SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_STEP);
   lot = MathFloor(lot / step) * step;
   return MathMax(SymbolInfoDouble(_Symbol, SYMBOL_VOLUME_MIN), lot);
}

double CalculateProfit(ENUM_POSITION_TYPE type) {
   double p = 0;
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         p += positionInfo.Profit() + positionInfo.Commission() + positionInfo.Swap();
   }
   return p;
}

void ClosePositions(ENUM_POSITION_TYPE type) {
   for(int i=PositionsTotal()-1; i>=0; i--) {
      if(positionInfo.SelectByIndex(i) && positionInfo.Magic() == MagicNumber && positionInfo.PositionType() == type)
         trade.PositionClose(positionInfo.Ticket());
   }
}

void CloseAllOrders() {
   ClosePositions(POSITION_TYPE_BUY);
   ClosePositions(POSITION_TYPE_SELL);
}

void SendTelegram(string message) {
   string url = "https://api.telegram.org/bot"+TelegramToken+"/sendMessage";
   string params = "chat_id="+TelegramChatID+"&text="+message+"&parse_mode=Markdown"; 
   char post_data[]; StringToCharArray(params, post_data);
   string headers = "Content-Type: application/x-www-form-urlencoded";
   uchar response[]; string result;
   WebRequest("POST", url, headers, 3000, post_data, response, result);
}
